# 実装・単体テスト・E2Eテスト運用マニュアル（itemモジュール例）

## 1. 実装方針
- **ドメイン層・アプリケーション層・インフラ層**の責務を明確に分離する。
- 例外・エラーケース（例: NotFound, バリデーションエラー）は必ず明示的にハンドリングする。
- `includeConsumed` などの分岐ロジックは、必ず全パターン網羅する。
- Prisma等の外部依存はインフラ層でラップし、テスト容易性を高める。

## 2. 単体テスト方針
- **テスト対象ごとにspecファイルを作成**（例: `item.repository.spec.ts`, `item.service.spec.ts`）。
- **分岐網羅（branch coverage 80%以上、理想は100%）**を目指す。
  - 例: `includeConsumed: true/false` の両方、エラー/正常系、例外throw分岐など。
- **モック/スタブ**を活用し、外部依存（DB, Service等）は直接叩かない。
- **テストケース例**:
  - CRUD全パターン（正常/異常）
  - 存在しないIDでのupdate/delete
  - `findAll`/`findByPantryId`の`includeConsumed`分岐
  - マッピング層のenum変換・例外
- **テスト失敗時は原因を特定し、テスト/実装両面から修正する**。
- **TypeScript/ESLintエラーは必ず解消する**（引数・オブジェクトリテラルの整形等）。
- **各テストは Arrange-Act-Assert パターンで実装する**
- **必要に応じて Parameterized Test でコンパクトにテストを記述する**

## 3. E2Eテスト方針
- E2Eテストは`test/`配下に配置し、APIのエンドツーエンド動作を検証する。
- **実DB/外部APIは原則モックまたはテスト用DBを利用**。
- **主要なユースケース（正常/異常）を網羅**。
- **コントローラ層のテスト**では、Service層をモックし、リクエスト/レスポンスの流れを確認する。

## 4. カバレッジ運用
- `pnpm test:cov` でカバレッジを計測。
- **statement/line/branch/function いずれも80%以上、理想は100%**を目指す。
- カバレッジレポートで未カバー分岐・エラーケースを特定し、テストを追加。

## 5. コードレビュー・運用
- PR時は必ずカバレッジレポートを確認。
- **分岐・例外・エラーケースの網羅性**を重点的にレビュー。
- **テストの可読性・保守性**も重視。

---

### 参考: item.controller.spec.ts テスト例
- Service層をjest.mockで差し替え、各APIのリクエスト/レスポンス・Service呼び出しを検証。
- CRUD, getItems, getItemsByPantry等の全パスをテスト。

---

このマニュアルは今後の実装・テスト運用の標準とし、随時改善・拡充すること。
